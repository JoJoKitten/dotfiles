#!/bin/sh
# chooses a host, the src file/directory and the dest directory
# with fzf and types the command to copy it with scp
hosts_file=~/.hosts

# $1 is the directory on the other machine (optional)
remote_dir="$1"
[ -z "$remote_dir" ] && remote_dir='.'

host=$(fzf < "$hosts_file" | cut -d "|" -f 2 | sed 's/ //g')
[ "$host" != "" ] || exit 0

users=$(grep "$host" "$hosts_file" | cut -d "|" -f 3 | sed 's/ //g')
# check if , in users
if [ "${users#*,}" = "$users" ]; then
    user="$users"
else
    user=$(echo "$users" | sed 's/,/\n/g' | fzf)
fi
[ "$user" != "" ] || exit 0

direction=$(printf "to\nfrom" | fzf --header="Direction")
[ "$direction" != "" ] || exit 0

if [ "$direction" = "to" ]; then
    src=$(find . | fzf -m --header='Choose src files/directories')
    dest="${user}@${host}:$(ssh "${user}@${host}" "find $remote_dir -type d" \
            | fzf --header='Choose dest directory')"
else
    src="${user}@${host}:$(ssh "${user}@${host}" "find $remote_dir" \
            | fzf -m --header='Choose src files/directories')"
    dest=$(find . -type d | fzf --header='Choose dest directory')
fi

# copy the command to clipboard
printf "scp -r %s %s" "$src" "$dest" | xclip -i

printf "Copying..."
scp -r $src "$dest"
